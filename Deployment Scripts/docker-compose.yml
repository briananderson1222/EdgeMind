# EdgeMind Production Docker Compose
# NOTE: Use docker-compose.local.yml for local development
#
# Required environment variables (set in .env or export before running):
#   - INFLUXDB_ADMIN_PASSWORD
#   - INFLUXDB_ADMIN_TOKEN
#   - MQTT_USERNAME
#   - MQTT_PASSWORD

services:
  chromadb:
    image: chromadb/chroma:latest
    container_name: chromadb
    ports:
      - "8000:8000"
    volumes:
      - chromadb-data:/data
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8000'"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD:?INFLUXDB_ADMIN_PASSWORD is required}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-proveit}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET:-factory}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_ADMIN_TOKEN:?INFLUXDB_ADMIN_TOKEN is required}
    volumes:
      - influxdb-data:/var/lib/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  backend:
    build: .
    container_name: edgemind-backend
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - MQTT_HOST=${MQTT_HOST:-mqtt://virtualfactory.proveit.services:1883}
      - MQTT_USERNAME=${MQTT_USERNAME:?MQTT_USERNAME is required}
      - MQTT_PASSWORD=${MQTT_PASSWORD:?MQTT_PASSWORD is required}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_ADMIN_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-proveit}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-factory}
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=${CHROMA_PORT:-8000}
      - CMMS_ENABLED=${CMMS_ENABLED:-false}
      - CMMS_PROVIDER=${CMMS_PROVIDER:-maintainx}
      - MAINTAINX_API_KEY=${MAINTAINX_API_KEY:-}
      - MAINTAINX_BASE_URL=${MAINTAINX_BASE_URL:-https://api.getmaintainx.com/v1}
      - MAINTAINX_DEFAULT_LOCATION_ID=${MAINTAINX_DEFAULT_LOCATION_ID:-}
      - MAINTAINX_DEFAULT_ASSIGNEE_ID=${MAINTAINX_DEFAULT_ASSIGNEE_ID:-}
    depends_on:
      chromadb:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    restart: unless-stopped

volumes:
  chromadb-data:
  influxdb-data:
