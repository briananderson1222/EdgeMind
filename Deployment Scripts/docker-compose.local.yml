# EdgeMind Local Development - Docker Compose
# Usage: ./local-deploy.sh (recommended) or docker compose -f docker-compose.local.yml up -d

services:
  chromadb:
    image: chromadb/chroma:latest
    container_name: edgemind-chromadb
    ports:
      - "${CHROMA_PORT:-8002}:8000"
    environment:
      - ANONYMIZED_TELEMETRY=FALSE
    volumes:
      - chromadb-data:/data
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8000'"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  kb-init:
    image: python:3.11-slim
    container_name: edgemind-kb-init
    entrypoint: ["/bin/sh", "-c", "pip install -q chromadb pymupdf && python /app/scripts/ingest_kb.py"]
    environment:
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - KB_COLLECTION=${KB_COLLECTION:-edgemind_sops}
      - KB_PATH=/app/knowledge-base
    volumes:
      - ./local:/app/scripts:ro
      - ../knowledge-base:/app/knowledge-base:ro
    depends_on:
      chromadb:
        condition: service_healthy
    restart: "no"

  influxdb:
    image: influxdb:2.7
    container_name: edgemind-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD:?INFLUXDB_ADMIN_PASSWORD is required - run ./local-deploy.sh to generate}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-proveit}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET:-factory}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_ADMIN_TOKEN:?INFLUXDB_ADMIN_TOKEN is required - run ./local-deploy.sh to generate}
    volumes:
      - influxdb-data:/var/lib/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  agent-chat:
    build:
      context: ../agent/chat
      dockerfile: Dockerfile
    container_name: edgemind-agent-chat
    ports:
      - "8080:8080"
    environment:
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      - BEDROCK_MODEL_ID=${BEDROCK_MODEL_ID:-us.anthropic.claude-sonnet-4-20250514-v1:0}
      - MCP_SERVER_URL=http://agentcore-gateway:8000/mcp
      - KB_BACKEND=${KB_BACKEND:-local}
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - KB_COLLECTION=${KB_COLLECTION:-edgemind_sops}
    depends_on:
      agentcore-gateway:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  agent-troubleshoot:
    build:
      context: ../agent/troubleshoot
      dockerfile: Dockerfile
    container_name: edgemind-agent-troubleshoot
    ports:
      - "8081:8080"
    environment:
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      - BEDROCK_MODEL_ID=${BEDROCK_MODEL_ID:-us.anthropic.claude-sonnet-4-20250514-v1:0}
      - MCP_SERVER_URL=http://agentcore-gateway:8000/mcp
      - KB_BACKEND=${KB_BACKEND:-local}
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - KB_COLLECTION=${KB_COLLECTION:-edgemind_sops}
    depends_on:
      agentcore-gateway:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  agent-anomaly:
    build:
      context: ../agent/anomaly
      dockerfile: Dockerfile
    container_name: edgemind-agent-anomaly
    ports:
      - "8082:8080"
    environment:
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      - BEDROCK_MODEL_ID=${BEDROCK_MODEL_ID:-us.anthropic.claude-sonnet-4-20250514-v1:0}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  agentcore-gateway:
    image: python:3.11-slim
    container_name: edgemind-agentcore-gateway
    entrypoint: ["/bin/sh", "-c", "apt-get update -qq && apt-get install -qq -y git && pip install -q uv && uvx --from 'git+https://github.com/briananderson1222/awslabs-mcp.git#subdirectory=src/openapi-mcp-server' awslabs.openapi-mcp-server --transport http --host 0.0.0.0 --port 8000"]
    ports:
      - "8001:8000"
    environment:
      - API_NAME=edgemind
      - API_BASE_URL=http://backend:3000
      - API_SPEC_URL=http://backend:3000/api-spec/v3
      - LOG_LEVEL=INFO
      - ENABLE_PROMETHEUS=false
      - ENABLE_OPERATION_PROMPTS=true
    command: ["--transport", "http", "--host", "0.0.0.0", "--port", "8000"]
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  backend:
    build:
      context: ..
      dockerfile: Deployment Scripts/Dockerfile
    container_name: edgemind-backend
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - PORT=3000
      - NODE_ENV=${NODE_ENV:-development}
      # OpenAPI spec generation for agentcore-gateway
      - GENERATE_OPENAPI=true
      # MQTT Configuration
      - MQTT_HOST=${MQTT_HOST:-mqtt://virtualfactory.proveit.services:1883}
      - MQTT_USERNAME=${MQTT_USERNAME:-proveitreadonly}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      # InfluxDB Configuration (uses internal Docker network)
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_ADMIN_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-proveit}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-factory}
      # ChromaDB Configuration (uses internal Docker network)
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=${CHROMA_PORT:-8000}
      # AgentCore URLs (internal Docker network)
      - AGENT_CHAT_URL=http://agent-chat:8080
      - AGENT_TROUBLESHOOT_URL=http://agent-troubleshoot:8080
      - AGENT_ANOMALY_URL=http://agent-anomaly:8080
      # AI Configuration (AWS Bedrock)
      - AWS_REGION=${AWS_REGION:-us-east-1}
      # Note: Don't set AWS_PROFILE - it conflicts with explicit credentials
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      - BEDROCK_MODEL_ID=${BEDROCK_MODEL_ID:-us.anthropic.claude-sonnet-4-20250514-v1:0}
      # Optional: Direct Anthropic API (if not using Bedrock)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Optional: Disable AI insights for testing
      - DISABLE_INSIGHTS=${DISABLE_INSIGHTS:-false}
    volumes:
      # Mount AWS credentials for Bedrock access
      - ${HOME}/.aws:/home/nodejs/.aws:ro
      # Mount frontend files for live reload (no rebuild needed)
      - ../index.html:/app/index.html:ro
      - ../styles.css:/app/styles.css:ro
      - ../app.js:/app/app.js:ro
      # Mount backend files (restart container to pick up changes)
      - ../server.js:/app/server.js:ro
      - ../lib:/app/lib:ro
    depends_on:
      influxdb:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    restart: unless-stopped

volumes:
  chromadb-data:
    name: edgemind-chromadb-data
  influxdb-data:
    name: edgemind-influxdb-data
