<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdgeMind - LIVE</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè≠</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="live-badge" id="live-badge">‚óè DISCONNECTED</div>

    <div class="container">
        <header>
            <div class="reply-logo">REPLY</div>
            <h1>EDGE MIND</h1>
            <div class="subtitle">Command Center - LIVE DATA</div>
            <div class="status-badge" id="system-status">‚óè CONNECTING...</div>
            <button class="settings-btn" onclick="openSettingsModal()">‚öô Settings</button>
        </header>

        <div class="dashboard-grid">
            <!-- Factory Selection -->
            <div class="card factory-overview">
                <div class="card-title">Virtual Factory Selection</div>
                <div class="factory-selector">
                    <div class="factory-btn active" data-factory="ALL">
                        <div>ALL ENTERPRISES</div>
                        <div class="factory-status">Combined View ‚Ä¢ Online</div>
                    </div>
                    <div class="factory-btn" data-factory="A">
                        <div>ENTERPRISE A</div>
                        <div class="factory-status">Glass Manufacturing ‚Ä¢ Online</div>
                    </div>
                    <div class="factory-btn" data-factory="B">
                        <div>ENTERPRISE B</div>
                        <div class="factory-status">Multi-Site Beverage ‚Ä¢ Online</div>
                    </div>
                    <div class="factory-btn" data-factory="C">
                        <div>ENTERPRISE C</div>
                        <div class="factory-status">Biotech Facility ‚Ä¢ Online</div>
                    </div>
                </div>
            </div>

            <!-- Metrics -->
            <div class="card metrics">
                <div class="card-title">Messages Received</div>
                <div class="metric-value" id="message-count">0</div>
                <div class="metric-label">Total MQTT Messages</div>
                <div class="metric-change positive">Live from broker</div>
            </div>

            <div class="card metrics">
                <div class="card-title">OEE Score</div>
                <div class="metric-value" style="color: var(--accent-green);" id="oee-score">--</div>
                <div class="metric-label">24h Average</div>
                <div class="metric-change positive" id="oee-status">Loading...</div>
            </div>

            <div class="card metrics">
                <div class="card-title">Active Sensors</div>
                <div class="metric-value" style="color: var(--accent-amber);" id="active-sensors">--</div>
                <div class="metric-label">Data Streams</div>
                <div class="metric-change positive">Detecting...</div>
            </div>

            <div class="card metrics">
                <div class="card-title">Anomalies</div>
                <div class="metric-value" style="color: var(--accent-magenta);" id="anomaly-count">0</div>
                <div class="metric-label">Detected by Claude</div>
                <div class="metric-change negative">AI Analysis Active</div>
            </div>

            <!-- Factory Events -->
            <div class="card live-stream">
                <div class="card-title">Factory Events</div>
                <div class="event-filter-tabs">
                    <button class="event-tab active" onclick="filterEvents('all', this)">All</button>
                    <button class="event-tab" onclick="filterEvents('oee', this)">OEE</button>
                    <button class="event-tab" onclick="filterEvents('state', this)">State</button>
                    <button class="event-tab" onclick="filterEvents('alarm', this)">Alarms</button>
                    <button class="event-tab pause-btn" id="stream-pause-btn" onclick="toggleStreamPause()">
                        <span id="pause-btn-text">‚è∏ Pause</span>
                    </button>
                </div>
                <div class="stream-container" id="mqtt-stream">
                    <div class="stream-line">
                        <span class="stream-timestamp">[--:--:--.---]</span>
                        <span class="stream-topic">Waiting for connection...</span>
                        <span class="stream-value"></span>
                    </div>
                </div>
            </div>

            <!-- AI Agent -->
            <div class="card ai-agent">
                <div class="card-title">
                    Claude AI Agent
                    <button class="maximize-btn" onclick="openAgentModal()" title="Expand">‚õ∂</button>
                </div>
                <div class="agent-header">
                    <div class="agent-avatar">C</div>
                    <div class="agent-status">
                        <div class="agent-name">Edge Minder</div>
                        <div class="agent-state" id="agent-state">‚óè Initializing...</div>
                    </div>
                </div>
                <div class="insight-tabs">
                    <button class="insight-tab active" onclick="filterInsights('all', this)">All Insights</button>
                    <button class="insight-tab" onclick="filterInsights('anomalies', this)">Anomalies (<span id="anomaly-tab-count">0</span>)</button>
                </div>
                <div class="anomaly-filter-control">
                    <div class="filter-input-group">
                        <input type="text" id="anomaly-filter-input" class="filter-input"
                               placeholder="Add filter rule (e.g., 'ignore anomalies below 10% deviation')"
                               maxlength="200">
                        <button class="filter-submit-btn" onclick="addAnomalyFilter()">Add Filter</button>
                    </div>
                    <div id="active-filters" class="active-filters-container"></div>
                </div>
                <div id="claude-insights-container">
                    <div class="agent-insights">
                        <div class="insight-text">
                            Waiting for data to analyze. Claude will provide real-time insights as factory data flows in...
                        </div>
                        <div class="insight-meta">Status: Standby ‚Ä¢ Waiting for MQTT messages</div>
                    </div>
                </div>
            </div>

            <!-- Factory Health Scorecard -->
            <div class="card health-scorecard">
                <div class="card-title">Factory Health Scorecard</div>
                <div class="scorecard-content">
                    <!-- OEE Gauge -->
                    <div class="oee-gauge-container">
                        <div class="oee-gauge">
                            <svg width="180" height="180">
                                <circle class="oee-gauge-bg" cx="90" cy="90" r="80"></circle>
                                <circle id="oee-gauge-fill" class="oee-gauge-fill" cx="90" cy="90" r="80"
                                        stroke-dasharray="502.65" stroke-dashoffset="502.65"></circle>
                            </svg>
                            <div class="oee-gauge-text">
                                <div class="oee-value" id="scorecard-oee-value">--</div>
                                <div class="oee-label">Overall OEE</div>
                            </div>
                        </div>
                        <div class="health-status">
                            <div class="status-indicator">
                                <div class="status-dot green" id="status-dot-healthy"></div>
                                <span id="status-text-healthy">Healthy</span>
                            </div>
                            <div class="status-indicator">
                                <div class="status-dot yellow" id="status-dot-warning"></div>
                                <span id="status-text-warning">Warning</span>
                            </div>
                            <div class="status-indicator">
                                <div class="status-dot red" id="status-dot-critical"></div>
                                <span id="status-text-critical">Critical</span>
                            </div>
                        </div>
                    </div>

                    <!-- Active Alerts -->
                    <div>
                        <div style="font-size: 0.9rem; font-weight: 700; margin-bottom: 10px; color: var(--accent-cyan);">Active Alerts</div>
                        <div id="active-alerts-list">
                            <div class="alert-item info">
                                <div class="alert-header">
                                    <span class="alert-severity" style="color: var(--accent-cyan);">INFO</span>
                                    <span class="alert-time">now</span>
                                </div>
                                <div class="alert-message">
                                    System initializing. Connecting to MQTT broker...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment State Monitor -->
            <div class="card equipment-state-panel">
                <div class="card-title">Equipment State Monitor</div>
                <div class="state-summary">
                    <div class="state-count running"><span id="state-running">0</span> Running</div>
                    <div class="state-count idle"><span id="state-idle">0</span> Idle</div>
                    <div class="state-count down"><span id="state-down">0</span> Down</div>
                </div>
                <div class="state-grid" id="equipment-state-grid">
                    <div class="heatmap-loading">Loading equipment states...</div>
                </div>
            </div>

            <!-- Production Line OEE -->
            <div class="card line-oee-panel">
                <div class="card-title">Production Line OEE</div>
                <div class="line-oee-grid" id="line-oee-grid">
                    <div class="heatmap-loading">Loading line OEE...</div>
                </div>
            </div>

            <!-- Chart Panels -->
            <div class="card chart-panel">
                <div class="card-title">OEE by Enterprise</div>
                <canvas id="oee-breakdown-chart"></canvas>
            </div>

            <div class="card chart-panel waste-chart">
                <div class="card-title">Waste & Defect Trends (24h)</div>
                <canvas id="waste-trend-chart"></canvas>
            </div>

            <div class="card chart-panel">
                <div class="card-title">Scrap by Production Line</div>
                <canvas id="scrap-by-line-chart"></canvas>
            </div>

            <!-- Quality Metrics Panel -->
            <div class="card quality-panel">
                <div class="card-title">Quality Metrics by Enterprise</div>
                <div class="quality-grid" id="quality-grid">
                    <div class="heatmap-loading">Loading quality metrics...</div>
                </div>
            </div>

            <div class="card chart-panel">
                <div class="card-title">Production Heatmap</div>
                <div class="heatmap-container" id="production-heatmap">
                    <div class="heatmap-loading">Loading factory status...</div>
                </div>
            </div>

            <!-- Connection Status -->
            <div class="connection-status">
                <div class="connection-item">
                    <div class="connection-indicator disconnected" id="mqtt-indicator"></div>
                    <div class="connection-info">
                        <span class="connection-label">MQTT Broker</span>
                        <span class="connection-value">virtualfactory.proveit.services:1883</span>
                    </div>
                </div>
                <div class="connection-item">
                    <div class="connection-indicator disconnected" id="claude-indicator"></div>
                    <div class="connection-info">
                        <span class="connection-label">AI Agent</span>
                        <span class="connection-value">Claude Sonnet 4 ‚Ä¢ Standby</span>
                    </div>
                </div>
                <div class="connection-item">
                    <div class="connection-indicator disconnected" id="data-indicator"></div>
                    <div class="connection-info">
                        <span class="connection-label">Data Rate</span>
                        <span class="connection-value" id="data-rate">0 msg/sec</span>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <div class="footer-logo">PROVEIT! CONFERENCE 2026</div>
            <div>Powered by Claude AI ‚Ä¢ Real-time Factory Insights</div>
        </footer>
    </div>

    <script src="app.js"></script>

    <!-- Agent Modal Overlay -->
    <div class="agent-modal-overlay" id="agent-modal-overlay">
        <div class="agent-modal">
            <div class="agent-modal-header">
                <div class="agent-modal-title">
                    <div class="agent-avatar-small">C</div>
                    <span>Edge Minder - AI Insights</span>
                </div>
                <button class="agent-modal-close modal-close-btn" onclick="closeAgentModal()">√ó</button>
            </div>
            <div class="agent-modal-tabs">
                <button class="insight-tab active" onclick="filterModalInsights('all', this)">All Insights</button>
                <button class="insight-tab" onclick="filterModalInsights('anomalies', this)">Anomalies (<span id="modal-anomaly-count">0</span>)</button>
            </div>
            <div class="agent-modal-content" id="agent-modal-content">
                <!-- Insights rendered here -->
            </div>
        </div>
    </div>

    <!-- Anomaly Details Modal -->
    <div class="anomaly-modal-overlay" id="anomaly-modal-overlay">
        <div class="anomaly-modal">
            <div class="anomaly-modal-header">
                <div class="anomaly-modal-title">Anomaly Details</div>
                <button class="anomaly-modal-close modal-close-btn" id="close-anomaly-modal">√ó</button>
            </div>
            <div class="anomaly-modal-content">
                <div class="anomaly-modal-text" id="anomaly-modal-text"></div>
                <div class="anomaly-modal-reasoning" id="anomaly-modal-reasoning"></div>
                <div class="anomaly-modal-meta">
                    <div class="anomaly-modal-meta-item">
                        <div class="anomaly-modal-meta-label">Severity</div>
                        <div class="anomaly-modal-meta-value" id="anomaly-modal-severity"></div>
                    </div>
                    <div class="anomaly-modal-meta-item">
                        <div class="anomaly-modal-meta-label">Detected At</div>
                        <div class="anomaly-modal-meta-value" id="anomaly-modal-timestamp"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal-overlay" id="settings-modal-overlay">
        <div class="settings-modal">
            <div class="settings-modal-header">
                <div class="settings-modal-title">Alert Threshold Settings</div>
                <button class="settings-modal-close modal-close-btn" onclick="closeSettingsModal()">√ó</button>
            </div>
            <div class="settings-modal-content">
                <div class="settings-group">
                    <label class="settings-label">OEE Baseline (%) - Below this is concerning</label>
                    <input type="number" id="setting-oeeBaseline" class="settings-input" min="0" max="100" step="1">
                </div>
                <div class="settings-group">
                    <label class="settings-label">OEE World Class (%) - Above this is excellent</label>
                    <input type="number" id="setting-oeeWorldClass" class="settings-input" min="0" max="100" step="1">
                </div>
                <div class="settings-group">
                    <label class="settings-label">Availability Minimum (%) - Below this is critical</label>
                    <input type="number" id="setting-availabilityMin" class="settings-input" min="0" max="100" step="1">
                </div>
                <div class="settings-group">
                    <label class="settings-label">Defect Rate Warning (%) - Above this triggers warning</label>
                    <input type="number" id="setting-defectRateWarning" class="settings-input" min="0" max="100" step="0.1">
                </div>
                <div class="settings-group">
                    <label class="settings-label">Defect Rate Critical (%) - Above this triggers critical</label>
                    <input type="number" id="setting-defectRateCritical" class="settings-input" min="0" max="100" step="0.1">
                </div>
                <div class="settings-actions">
                    <button class="settings-save-btn" onclick="saveSettings()">Save Settings</button>
                    <button class="settings-cancel-btn" onclick="closeSettingsModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ask Agent Chat Panel -->
    <div class="chat-panel" id="chat-panel">
        <div class="chat-header">
            <div class="chat-title">Ask Agent</div>
            <button class="chat-close-btn" onclick="toggleChatPanel()">√ó</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="chat-welcome">
                Ask me anything about the factory data. Try one of these:
            </div>
            <div class="suggested-questions">
                <button class="suggested-question" onclick="handleSuggestedQuestion('What is impacting Enterprise B\'s OEE?')">
                    What is impacting Enterprise B's OEE?
                </button>
                <button class="suggested-question" onclick="handleSuggestedQuestion('Which equipment has been down the longest?')">
                    Which equipment has been down the longest?
                </button>
                <button class="suggested-question" onclick="handleSuggestedQuestion('Where is waste coming from in Enterprise A?')">
                    Where is waste coming from in Enterprise A?
                </button>
                <button class="suggested-question" onclick="handleSuggestedQuestion('What is the status of Enterprise C batches?')">
                    What is the status of Enterprise C batches?
                </button>
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" id="chat-input" class="chat-input" placeholder="Ask about factory data..." />
            <button class="chat-send-btn" onclick="sendChatMessage()">
                <span>‚ñ∂</span>
            </button>
        </div>
    </div>

    <button class="chat-toggle-btn" id="chat-toggle-btn" onclick="toggleChatPanel()">
        üí¨ Ask Agent
    </button>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="powered-by">Powered by</div>
            <div class="reply-footer-logo">REPLY</div>
            <div class="footer-divider"></div>
            <div class="footer-tagline">Driving Digital Transformation</div>
        </div>
    </footer>
</body>
</html>
